machine:
  services:
    - docker
  hosts:
    test.loc: 127.0.0.1

dependencies:
  pre:
    - docker pull million12/mariadb:
        background: true

  override:
    # Build abstract million12/typo3-flow-neos-abstract image
    - docker build --tag=docker-neos-alpine-test .

  post:
    # Launch DB backend
    - docker run -d --name=db --env="MARIADB_PASS=pass" million12/mariadb
    - docker logs -f db | tee -a ${CIRCLE_ARTIFACTS}/db.log:
        background: true

# Run tests
test:
  override:
    # ##################################################
    # Default setup
    # ##################################################
    # Launch it
    - docker run -d --name=web -p=8000:80 --link=db:db --env="REPOSITORY_URL='https://github.com/neos/neos-development-distribution'" --env="SITE_PACKAGE='Neos.Demo'" docker-neos-alpine-test
    - docker logs -f web > ${CIRCLE_ARTIFACTS}/web.log:
        background: true
    # Wait till container is fully configured
    - while true; do if grep "ready to handle connections" ${CIRCLE_ARTIFACTS}/web.log; then break; else echo "Waiting for web container to finish provisioning..." && sleep 1; fi done
    # Test: do basic front-end tests
    - curl -L --head http://test.loc:8000 && curl -s -L http://test.loc:8000
    - curl -s -L --head http://test.loc:8000 | grep "HTTP/1.1 200 OK" && curl -s -L --head http://test.loc:8000 | grep "X-Flow-Powered" && curl -s -L --head http://test.loc:8000 | grep "/flow/welcome"
    - curl -s -L http://test.loc:8000 | grep "Kickstart your first package"
    # Clean up
    - docker rm -f web || true
